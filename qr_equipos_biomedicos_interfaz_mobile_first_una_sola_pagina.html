<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ficha de Equipo Biom√©dico</title>
  <meta name="description" content="Interfaz mobile‚Äëfirst para consultar datos de equipos biom√©dicos v√≠a QR." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ü©∫</text></svg>">
  <style>
    :root{
      --bg:#0b0f14; --card:#121821; --muted:#7d8b9e; --text:#e6edf5; --primary:#23c4a2; --accent:#7aa2f7; --danger:#ff6b6b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f14 0%,#0b121a 100%);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif}
    .wrap{max-width:960px;margin:0 auto;padding:20px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;display:grid;place-items:center;border-radius:12px;background:linear-gradient(135deg,#1f2937 0%,#0e7490 100%);}
    h1{font-size:1.25rem;margin:0}
    .card{background:rgba(18,24,33,.85);backdrop-filter:saturate(1.2) blur(8px);border:1px solid #1d2633;border-radius:var(--radius);padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:700px){.row{grid-template-columns:1fr 1fr}}
    label{font-size:.8rem;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #223047;background:#0d131b;color:var(--text)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #1d2633;background:#0f1722;color:var(--text);padding:10px 14px;border-radius:12px;text-decoration:none;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,#0a564d,#23c4a2);border-color:#0e7c68;color:#0b1214;font-weight:600}
    .btn.ghost{background:transparent}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#0b1420;border:1px solid #1f2a3a;color:var(--muted);font-size:.8rem}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:6px 12px}
    .kv b{color:var(--accent);font-weight:600}
    .empty{color:var(--muted);font-style:italic}
    .footer{margin-top:16px;color:#9fb0c8;font-size:.85rem}
    .warn{border-left:4px solid var(--danger);padding:10px 12px;background:#1a0f12;border-radius:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">ü©∫</div>
        <div>
          <h1>Ficha de Equipo Biom√©dico</h1>
          <div class="pill" id="pill-equipo">ID: ‚Äî</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost" id="btn-share" title="Compartir">üîó Compartir</button>
      </div>
    </header>

    <section class="card" id="notice"></section>

    <section class="card" id="ficha"></section>

    <section class="card">
      <div class="row">
        <div>
          <h3 style="margin-top:0">Actualizar / Capturar datos</h3>
          <p class="empty">Sin backend: los cambios se guardan en <b>localStorage</b> por <b>equipo_id</b>.</p>
          <div class="grid">
            <div>
              <label>Fecha de compra</label>
              <input type="date" id="in-fecha" />
            </div>
            <div>
              <label>Valor de compra</label>
              <input type="number" id="in-valor" placeholder="COP" />
            </div>
            <div>
              <label>Tiempo de uso (horas)</label>
              <input type="number" id="in-uso" />
            </div>
            <div>
              <label>Ubicaci√≥n</label>
              <input type="text" id="in-ubicacion" placeholder="Sala / Servicio" />
            </div>
            <div>
              <label>Marca / Modelo</label>
              <input type="text" id="in-modelo" placeholder="Marca Modelo" />
            </div>
            <div>
              <label>N¬∞ Inventario</label>
              <input type="text" id="in-inv" placeholder="Inventario" />
            </div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="btn-guardar">üíæ Guardar</button>
            <button class="btn" id="btn-reiniciar">üßπ Limpiar (solo este equipo)</button>
          </div>
        </div>
        <div>
          <h3 style="margin-top:0">Previsualizaci√≥n</h3>
          <div class="kv" id="preview"></div>
        </div>
      </div>
    </section>

    <p class="footer">Consejo: publica este archivo en <b>https</b> (GitHub Pages/Netlify/intranet). El protocolo <code>file://</code> solo funciona localmente y no es accesible desde otros dispositivos.
      Para compatibilidad adicional, esta p√°gina tambi√©n acepta la forma <code>#/equipo_id</code> (fragmento) adem√°s de <code>?equipo_id=</code>.</p>
  </div>

<script>
  // Utilidad: obtener equipo_id desde query o hash
  function getEquipoId(){
    const p = new URLSearchParams(location.search);
    let id = p.get('equipo_id');
    if(!id){
      // Alternativa: usar fragmento #/BM-XXX
      const m = location.hash.match(/^#\/?(.+)$/);
      if(m) id = m[1];
    }
    return id ? decodeURIComponent(id.trim()) : null;
  }

  // Peque√±o almac√©n local por equipo (sin backend)
  const STORE_KEY = 'equipos_biomedicos_store_v1';
  const DB = {
    _load(){
      try{ return JSON.parse(localStorage.getItem(STORE_KEY) || '{}'); }catch{ return {}; }
    },
    _save(obj){ localStorage.setItem(STORE_KEY, JSON.stringify(obj)); },
    read(id){ return this._load()[id] || null; },
    write(id, data){ const d=this._load(); d[id]=data; this._save(d); },
    del(id){ const d=this._load(); delete d[id]; this._save(d); }
  };

  // Datos demo opcionales (se usan si no hay registro en localStorage)
  const DEMO = {
    "BM-VENT-000123": {
      id:"BM-VENT-000123",
      modelo:"Hamilton C1",
      ubicacion:"UCI Adultos",
      fecha_compra:"2023-08-10",
      valor_compra: 78000000,
      horas_uso: 4120
    }
  };

  const equipoId = getEquipoId();
  const pill = document.getElementById('pill-equipo');
  const ficha = document.getElementById('ficha');
  const prev = document.getElementById('preview');
  const notice = document.getElementById('notice');

  function money(num){
    if(num===undefined || num===null || num==='') return '‚Äî';
    try{ return new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}).format(Number(num)); }catch{ return String(num); }
  }

  function renderFicha(data){
    if(!data){
      ficha.innerHTML = `<div class="empty">No hay datos guardados para este equipo todav√≠a.</div>`;
      prev.innerHTML = '<span class="empty">‚Äî</span>';
      return;
    }
    const rows = [
      ['ID', data.id || '‚Äî'],
      ['Marca/Modelo', data.modelo || '‚Äî'],
      ['Ubicaci√≥n', data.ubicacion || '‚Äî'],
      ['Fecha de compra', data.fecha_compra || '‚Äî'],
      ['Valor de compra', money(data.valor_compra)],
      ['Tiempo de uso (h)', data.horas_uso ?? '‚Äî']
    ].map(([k,v])=>`<div class="kv"><b>${k}</b><div>${v}</div></div>`).join('');
    ficha.innerHTML = rows;
    prev.innerHTML = rows;
  }

  function fillForm(data){
    document.getElementById('in-fecha').value = data?.fecha_compra || '';
    document.getElementById('in-valor').value = data?.valor_compra ?? '';
    document.getElementById('in-uso').value = data?.horas_uso ?? '';
    document.getElementById('in-ubicacion').value = data?.ubicacion || '';
    document.getElementById('in-modelo').value = data?.modelo || '';
    document.getElementById('in-inv').value = data?.inventario || '';
  }

  function bootstrap(){
    pill.textContent = `ID: ${equipoId || '‚Äî'}`;

    // Avisos de entorno
    const isHttp = location.protocol.startsWith('http');
    notice.innerHTML = isHttp
      ? '<div>‚úÖ Acceso por <b>HTTP/HTTPS</b>. Esta URL es accesible desde otros dispositivos en la misma red o por Internet (seg√∫n tu hosting).</div>'
      : '<div class="warn">‚ö†Ô∏è Est√°s abriendo por <b>file://</b>. Otros dispositivos (por ejemplo, tu celular) <b>no podr√°n</b> acceder a este archivo en tu PC. Publica este HTML en un hosting (intranet/Netlify/GitHub Pages) para que el QR funcione en m√≥viles.</div>';

    // Cargar datos
    let data = equipoId ? (DB.read(equipoId) || DEMO[equipoId]) : null;
    if(!data && !equipoId){
      ficha.innerHTML = `<div class="empty">Falta <code>equipo_id</code>. Agrega <code>?equipo_id=TU_ID</code> o <code>#/TU_ID</code> a la URL.</div>`;
      return;
    }
    if(!data){ data = { id:equipoId }; }
    if(!data.id) data.id = equipoId;

    renderFicha(data);
    fillForm(data);

    // Handlers
    document.getElementById('btn-guardar').onclick = () => {
      const newData = {
        id: equipoId,
        fecha_compra: document.getElementById('in-fecha').value || null,
        valor_compra: Number(document.getElementById('in-valor').value || 0) || null,
        horas_uso: Number(document.getElementById('in-uso').value || 0) || null,
        ubicacion: document.getElementById('in-ubicacion').value || null,
        modelo: document.getElementById('in-modelo').value || null,
        inventario: document.getElementById('in-inv').value || null,
      };
      DB.write(equipoId, newData);
      renderFicha(newData);
      alert('Guardado localmente (localStorage).');
    };

    document.getElementById('btn-reiniciar').onclick = () => {
      if(confirm('¬øBorrar datos locales de este equipo?')){
        DB.del(equipoId);
        const base = location.href.replace(/([?#].*)$/, '');
        renderFicha({id:equipoId});
        fillForm({});
      }
    };

    document.getElementById('btn-share').onclick = async () => {
      const url = new URL(location.href);
      url.searchParams.set('equipo_id', equipoId || '');
      const shareUrl = url.toString();
      try{
        if(navigator.share){
          await navigator.share({title:'Ficha equipo', text:`Equipo ${equipoId}`, url: shareUrl});
        }else{
          await navigator.clipboard.writeText(shareUrl);
          alert('Enlace copiado al portapapeles');
        }
      }catch(e){
        await navigator.clipboard.writeText(shareUrl);
        alert('Enlace copiado al portapapeles');
      }
    };

    // Registrar Service Worker solo en HTTPS/localhost
    if(isHttp && 'serviceWorker' in navigator){
      try{ navigator.serviceWorker.register('sw.js'); }catch{ /* opcional */ }
    }
  }

  bootstrap();
</script>

<!-- Service Worker m√≠nimo (opcional). Guarda este contenido como sw.js en el mismo directorio cuando publiques sobre http/https)
self.addEventListener('install', (e)=>{self.skipWaiting()});
self.addEventListener('activate', (e)=>{clients.claim()});
self.addEventListener('fetch', (e)=>{ /* Puedes cachear archivos est√°ticos aqu√≠ si lo deseas */ });
-->

</body>
</html>
